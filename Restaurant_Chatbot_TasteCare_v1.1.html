<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TasteCare ‚Äì Sentiment-Aware Restaurant Assistant (TH/EN)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nice-scrollbar::-webkit-scrollbar{width:8px;height:8px}
    .nice-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
    .nice-scrollbar{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
  <div class="min-h-screen max-w-5xl mx-auto p-4 md:p-8">
    <header class="mb-4">
      <div class="rounded-2xl bg-gradient-to-r from-pink-500 via-fuchsia-500 to-indigo-500 text-white p-6 shadow-lg flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold">üçú TasteCare ‚Äî <span class="font-bold">Sentiment-Aware</span> Restaurant Assistant</h1>
          <p class="opacity-95 mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞ ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö TH/EN ‚Ä¢ ‡πÉ‡∏ä‡πâ ‚Äú‡∏Ñ‡∏∞/‡∏Ñ‡πà‡∏∞‚Äù</p>
          <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
            <span class="bg-white/20 px-2.5 py-1 rounded-full">Mood: ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡∏î‡∏µ‡πÉ‡∏à/‡πÄ‡∏®‡∏£‡πâ‡∏≤/‡πÄ‡∏â‡∏¢ ‡πÜ</span>
            <span class="bg-white/20 px-2.5 py-1 rounded-full">Tags: ‡πÄ‡∏™‡πâ‡∏ô ‚Ä¢ comfort ‚Ä¢ light ‚Ä¢ celebrate</span>
            <span class="bg-white/20 px-2.5 py-1 rounded-full">Budget TTL ‚Ä¢ Thai numerals</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="lang" class="text-sm opacity-90">‡∏†‡∏≤‡∏©‡∏≤ / Language</label>
          <select id="lang" class="text-sm rounded-lg px-2 py-1 text-slate-800 bg-white/90">
            <option value="th">‡πÑ‡∏ó‡∏¢ (TH)</option>
            <option value="en">English (EN)</option>
          </select>
        </div>
      </div>
    </header>

    <main class="grid md:grid-cols-3 gap-4">
      <section class="md:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 to-indigo-500 grid place-items-center text-white">ü§ñ</div>
              <div>
                <div class="font-semibold leading-tight">TasteCare Assistant</div>
                <div class="text-xs text-slate-500">‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢ / help‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnClear" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó</button>
              <button id="btnHelp" class="text-xs px-3 py-1.5 rounded-full bg-pink-50 text-pink-700 hover:bg-pink-100">‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
            </div>
          </div>

          <div id="chat" class="h-[56vh] md:h-[62vh] overflow-y-auto nice-scrollbar p-4 space-y-3"></div>

          <div class="border-t border-slate-200 p-3">
            <div class="flex items-end gap-2">
              <div class="flex-1">
                <textarea id="input" rows="2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‚Äò‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ü‡∏• ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô ‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80‚Äô, ‚Äò‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≤ ‡πÜ‚Äô, ‚Äò‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô ‡∏≠‡∏¢‡∏≤‡∏Å‡∏â‡∏•‡∏≠‡∏á‚Äô, ‚Äò‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î‚Äô, ‚Äò‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‚Äô" class="w-full resize-none rounded-xl border-slate-300 focus:border-pink-400 focus:ring-pink-300"></textarea>
                <div id="quickbar" class="flex flex-wrap gap-2 mt-2 text-sm"></div>
              </div>
              <button id="send" class="px-4 py-2 rounded-xl bg-pink-600 text-white hover:bg-pink-700 active:scale-[.99]">‡∏™‡πà‡∏á</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="md:col-span-1 space-y-4">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4">
          <h2 class="font-semibold mb-2">üß™ Metrics</h2>
          <ul class="text-sm space-y-1" id="metrics">
            <li>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="m_total">0</b></li>
            <li>‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b id="m_ok">0</b></li>
            <li>Fallback: <b id="m_fb">0</b></li>
            <li>Coverage ‚âà <b id="m_cov">0%</b></li>
          </ul>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4">
          <h2 class="font-semibold mb-2">‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</h2>
          <div class="text-sm leading-6" id="storeInfo"></div>
          <div class="mt-3 flex flex-wrap gap-2">
            <a id="mapsLink" target="_blank" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
            <button id="btnNavigate" class="text-xs px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô</button>
            <button id="btnShowMenu" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ===== Config =====
    const PAGE_SIZE = 6;
    const TTL = { budget:3, taste:3, category:3, veg:10, mood:4 };
    const P = { say:'‡∏Ñ‡πà‡∏∞', ask:'‡∏Ñ‡∏∞' };

    // ===== Data =====
    const STORE = {
      meta: {
        name: "‡∏Ñ‡∏£‡∏±‡∏ß‡∏£‡∏¥‡∏°‡∏ó‡∏≤‡∏á",
        hours: "‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô 10:00‚Äì20:00 ‡∏ô.",
        phone: "081-234-5678",
        address: "‡∏ã‡∏≠‡∏¢ A ‡∏ñ‡∏ô‡∏ô B ‡∏ï‡∏¥‡∏î C ‡πÅ‡∏Ç‡∏ß‡∏á/‡πÄ‡∏Ç‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£",
        mapsUrl: "https://maps.google.com/?q=13.7563,100.5018",
        lat: 13.7563, lng: 100.5018,
      },
      promos: [
        { title: "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 10%", desc: "‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏à.-‡∏û‡∏§." },
        { title: "Member Stamp 8 ‡∏ü‡∏£‡∏µ 1", desc: "‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏ï‡∏°‡∏õ‡πå‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" },
      ],
      menu: [
        // Staples
        { name: "‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á", price: 120, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: [] },
        { name: "‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏Å‡∏∏‡πâ‡∏á‡∏™‡∏î", price: 80,  category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: false, tags: ["‡πÄ‡∏™‡πâ‡∏ô"] },
        { name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π", price: 60,     category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["comfort"] },
        { name: "‡∏™‡πâ‡∏°‡∏ï‡∏≥‡πÑ‡∏ó‡∏¢", price: 60,      category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: [] },
        { name: "‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏Å‡πà", price: 95, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: false, tags: [] },
        { name: "‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ", price: 65, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: true,  tags: [] },
        // Drinks & Desserts
        { name: "‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡∏ß‡∏≤‡∏ô‡∏¥‡∏•‡∏•‡∏≤", price: 45, category: "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true, tags: ["celebrate","comfort","sweet"] },
        { name: "‡∏ä‡∏≤‡∏ô‡∏°‡πÄ‡∏¢‡πá‡∏ô", price: 35,       category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true, tags: ["sweet"] },
        { name: "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏¢‡πá‡∏ô", price: 35,    category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true, tags: ["sweet"] },
        // Mood-specific & noodles
        { name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß", price: 45, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["comfort"] },
        { name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏Å‡∏á‡∏Å‡∏∞‡∏´‡∏£‡∏µ‡πà‡∏´‡∏°‡∏π", price: 85, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: false, tags: ["comfort"] },
        { name: "‡πÇ‡∏à‡πä‡∏Å‡πÑ‡∏Å‡πà", price: 55, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏ö‡∏≤","‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢","light"] },
        { name: "‡∏ã‡∏∏‡∏õ‡πÑ‡∏Å‡πà‡πÉ‡∏™", price: 65, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏ö‡∏≤","‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢","light"] },
        { name: "‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏Ñ‡∏±‡πâ‡∏ô‡∏™‡∏î", price: 45, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true,  tags: ["light"] },
        { name: "‡∏°‡πá‡∏≠‡∏Å‡πÄ‡∏ó‡∏•‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 95, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true,  tags: ["celebrate"] },
        { name: "‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï", price: 55, category: "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true, tags: ["comfort","sweet","celebrate"] },
        // Noodles
        { name: "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠", price: 65, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏™‡πâ‡∏ô"] },
        { name: "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏°‡∏¢‡∏≥", price: 75, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏™‡πâ‡∏ô"] },
        { name: "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á", price: 70, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏™‡πâ‡∏ô","comfort"] },
        { name: "‡∏Å‡πã‡∏ß‡∏¢‡∏à‡∏±‡πä‡∏ö‡∏ô‡πâ‡∏≥‡πÉ‡∏™", price: 70, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏™‡πâ‡∏ô","‡πÄ‡∏ö‡∏≤","light"] },
        { name: "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô‡∏ô‡πâ‡∏≥‡∏¢‡∏≤", price: 70, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false, tags: ["‡πÄ‡∏™‡πâ‡∏ô"] }
      ],
    };

    // ===== Helpers =====
    function normalize(s){ return (s||'').toLowerCase().trim(); }
    function stripSpaces(s){ return (s||'').replace(/\s+/g,''); }
    const TH_UNITS = {'‡∏®‡∏π‡∏ô‡∏¢‡πå':0,'‡∏´‡∏ô‡∏∂‡πà‡∏á':1,'‡∏ô‡∏∂‡∏á':1,'‡πÄ‡∏≠‡πá‡∏î':1,'‡∏™‡∏≠‡∏á':2,'‡∏¢‡∏µ‡πà':2,'‡∏™‡∏≤‡∏°':3,'‡∏™‡∏µ‡πà':4,'‡∏´‡πâ‡∏≤':5,'‡∏´‡∏Å':6,'‡πÄ‡∏à‡πá‡∏î':7,'‡πÅ‡∏õ‡∏î':8,'‡πÄ‡∏Å‡πâ‡∏≤':9};

    function thaiTextToNumber(text){
      text = stripSpaces(text);
      if (/‡∏£‡πâ‡∏≠‡∏¢/.test(text)) return 100;
      const m = text.match(/((?:‡∏¢‡∏µ‡πà|‡∏´‡∏ô‡∏∂‡πà‡∏á|‡∏ô‡∏∂‡∏á|‡∏™‡∏≠‡∏á|‡∏™‡∏≤‡∏°|‡∏™‡∏µ‡πà|‡∏´‡πâ‡∏≤|‡∏´‡∏Å|‡πÄ‡∏à‡πá‡∏î|‡πÅ‡∏õ‡∏î|‡πÄ‡∏Å‡πâ‡∏≤)?‡∏™‡∏¥‡∏ö)(?:‡∏´‡∏ô‡∏∂‡πà‡∏á|‡∏ô‡∏∂‡∏á|‡∏™‡∏≠‡∏á|‡∏™‡∏≤‡∏°|‡∏™‡∏µ‡πà|‡∏´‡πâ‡∏≤|‡∏´‡∏Å|‡πÄ‡∏à‡πá‡∏î|‡πÅ‡∏õ‡∏î|‡πÄ‡∏Å‡πâ‡∏≤)?/);
      if (m){
        const tensWord = m[1].replace('‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡∏¥‡∏ö','‡∏™‡∏¥‡∏ö').replace('‡∏ô‡∏∂‡∏á‡∏™‡∏¥‡∏ö','‡∏™‡∏¥‡∏ö');
        let tens = 0;
        if (tensWord==='‡∏™‡∏¥‡∏ö') tens = 10; else {
          const key = tensWord.replace('‡∏™‡∏¥‡∏ö','');
          tens = (key==='‡∏¢‡∏µ‡πà'?2:TH_UNITS[key]||0)*10;
        }
        const unitMatch = (text.match(/‡∏™‡∏¥‡∏ö(‡∏´‡∏ô‡∏∂‡πà‡∏á|‡∏ô‡∏∂‡∏á|‡∏™‡∏≠‡∏á|‡∏™‡∏≤‡∏°|‡∏™‡∏µ‡πà|‡∏´‡πâ‡∏≤|‡∏´‡∏Å|‡πÄ‡∏à‡πá‡∏î|‡πÅ‡∏õ‡∏î|‡πÄ‡∏Å‡πâ‡∏≤)$/) || [])[1];
        const unit = unitMatch ? (unitMatch==='‡∏ô‡∏∂‡∏á'?1:TH_UNITS[unitMatch]) : 0;
        return tens + unit;
      }
      if (TH_UNITS[text]!=null) return TH_UNITS[text];
      return null;
    }
    function parseBudget(raw){
      const map={'‡πê':0,'‡πë':1,'‡πí':2,'‡πì':3,'‡πî':4,'‡πï':5,'‡πñ':6,'‡πó':7,'‡πò':8,'‡πô':9};
      const text = raw.replace(/[‡πê-‡πô]/g,d=>map[d]);
      const d = text.match(/\d{2,4}/); if (d) return parseInt(d[0],10);
      const ctx = raw.match(/(‡∏£‡πâ‡∏≠‡∏¢|‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö(?:[‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ô‡∏∂‡∏á‡∏™‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏™‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏´‡∏Å‡πÄ‡∏à‡πá‡∏î‡πÅ‡∏õ‡∏î‡πÄ‡∏Å‡πâ‡∏≤])?|[‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ô‡∏∂‡∏á‡∏™‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏™‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏´‡∏Å‡πÄ‡∏à‡πá‡∏î‡πÅ‡∏õ‡∏î‡πÄ‡∏Å‡πâ‡∏≤]‡∏™‡∏¥‡∏ö(?:[‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ô‡∏∂‡∏á‡∏™‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏™‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏´‡∏Å‡πÄ‡∏à‡πá‡∏î‡πÅ‡∏õ‡∏î‡πÄ‡∏Å‡πâ‡∏≤])?)/);
      if (ctx){ const val = thaiTextToNumber(ctx[1]); if (val!=null) return val; }
      return null;
    }
    function has(pats, t){ return pats.some(p=>p.test(t)); }
    function findItemByName(q){
      const t = stripSpaces(q);
      return STORE.menu.find(m=>stripSpaces(m.name).includes(t) || t.includes(stripSpaces(m.name)));
    }

    // ===== Mood detection =====
    function parseMood(text){
      const t = normalize(text);
      if (/(‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢|‡∏•‡πâ‡∏≤|‡πÄ‡∏û‡∏•‡∏µ‡∏¢|‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î|burn ?out|‡∏™‡∏ï(‡∏£|)‡πÄ‡∏£‡∏™|stress|‡∏Å‡∏±‡∏á‡∏ß‡∏•|‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß|‡∏´‡∏ô‡∏±‡∏Å‡∏´‡∏±‡∏ß)/i.test(t)) return 'tired';
      if (/(‡∏î‡∏µ‡πÉ‡∏à|‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô|excited|‡∏õ‡∏•‡∏∑‡πâ‡∏°|‡∏â‡∏•‡∏≠‡∏á|celebrate|‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î|‡πÄ‡∏Æ‡∏Æ‡∏≤|‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ|happy)/i.test(t)) return 'happy';
      if (/(‡πÄ‡∏®‡∏£‡πâ‡∏≤|‡πÄ‡∏ü‡∏•|‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à|‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î|‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à|‡πÇ‡∏Å‡∏£‡∏ò|‡∏á‡∏≠‡∏ô|‡πÄ‡∏ã‡πá‡∏á|‡πÄ‡∏´‡∏á‡∏≤|‡∏´‡∏°‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à|sad)/i.test(t)) return 'sad';
      if (/(‡πÄ‡∏â‡∏¢ ‡πÜ|‡πÄ‡∏â‡∏¢‡πÜ|‡∏õ‡∏Å‡∏ï‡∏¥|‡πÇ‡∏≠‡πÄ‡∏Ñ|‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ|normal|‡πÄ‡∏â‡∏¢)/i.test(t)) return 'neutral';
      return null;
    }

    // ===== Slots parsing =====
    function parseSlots(text){
      const t = normalize(text);
      const slots = {excludeCategories:[], tags:[]};

      // taste/heat
      if (/(‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î|‡∏Å‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ|‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢|mild)/i.test(t)) slots.taste = '‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î';
      else if (/(‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á|‡∏Å‡∏•‡∏≤‡∏á|medium)/i.test(t)) slots.taste = '‡∏Å‡∏•‡∏≤‡∏á';
      else if (/(‡πÄ‡∏ú‡πá‡∏î|‡∏à‡∏±‡∏î|spicy|hot|‡∏Ç‡∏≠‡∏á‡πÄ‡∏ú‡πá‡∏î)/i.test(t)) slots.taste = '‡πÄ‡∏ú‡πá‡∏î';

      // category
      if (/(‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|dessert)/i.test(t)) slots.category = '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô';
      else if (/(‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|drink|beverage|‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡πâ‡∏≥|‡∏ô‡πâ‡∏≥(‡∏î‡∏∑‡πà‡∏°)?|(^|\\s)‡∏ô‡πâ‡∏≥(\\s|$))/i.test(t)) slots.category = '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°';
      else if (/(‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ß|‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏≤‡∏ß|‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏≤‡∏ß|‡∏Ñ‡∏≤‡∏ß ‡πÜ|‡∏Ñ‡∏≤‡∏ß‡πÜ|‡∏≠‡∏≤‡∏´‡∏≤‡∏£(?!‡∏´‡∏ß‡∏≤‡∏ô))/i.test(t)) slots.category = '‡∏≠‡∏≤‡∏´‡∏≤‡∏£';

      // noodles
      if (/(‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô|‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß|‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà|‡∏£‡∏≤‡πÄ‡∏°‡∏á|‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢|‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ|‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô|‡πÄ‡∏™‡πâ‡∏ô)/i.test(t)) slots.tags = [...new Set([...(slots.tags||[]),'‡πÄ‡∏™‡πâ‡∏ô'])];

      // includes/excludes
      if (/(‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|no dessert)/i.test(t)) slots.excludeCategories.push('‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô');
      if (/(‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|no drinks?|‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ô‡πâ‡∏≥)/i.test(t)) slots.excludeCategories.push('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°');

      // veg
      if (/(‡πÄ‡∏à|‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥|veg|vegetarian|‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)/i.test(t)) slots.veg = true;
      if (/(‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ú‡∏±‡∏Å|no veg|‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å‡πÑ‡∏´‡∏°|‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏±‡∏Å)/i.test(t)) slots.veg = false;

      // budget
      const b = parseBudget(t); if (b!=null) slots.budget=b;

      // mood
      const mood = parseMood(t); if (mood) slots.mood=mood;

      return slots;
    }

    // ===== Context =====
    const CTX = { 
      last_intent:null, 
      slots:{ budget:null, taste:null, category:null, veg:null, excludeCategories:[], tags:[], mood:null },
      ttl:{ budget:0, taste:0, category:0, veg:0, mood:0 },
      filtered:[], page:0,
      justChangedCategory:false,
    };
    function applyTTL(parsed){
      const prevCat = CTX.slots.category;
      CTX.justChangedCategory = false;
      ['budget','taste','category','veg','mood'].forEach(k=>{
        if (parsed[k]!=null){ 
          if (k==='category' && parsed.category!==prevCat){
            CTX.justChangedCategory = true;
          }
          CTX.ttl[k]=TTL[k]; 
          CTX.slots[k]=parsed[k]; 
        } else { 
          if (CTX.ttl[k]>0){ 
            CTX.ttl[k]--; 
            if (CTX.ttl[k]===0){ CTX.slots[k]=null; } 
          } 
        }
      });
      // tags overwrite if present
      if (parsed.tags && parsed.tags.length) CTX.slots.tags = parsed.tags;
      // category change clears budget to avoid stale constraint
      if (CTX.justChangedCategory){
        CTX.slots.budget = null;
        CTX.ttl.budget = 0;
      }
      CTX.slots.excludeCategories = (parsed.excludeCategories && parsed.excludeCategories.length) ? parsed.excludeCategories : [];
    }

    // ===== Intent Matching =====
    function matchIntent(text){
      const t = normalize(text);
      if (has([/(‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ|‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ|‡∏î‡∏µ‡∏Ñ‡πà‡∏∞+|‡∏î‡∏µ‡∏Ñ‡∏∞|hello|hi|hey)/i], t)) return 'greet';
      if (has([/(‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢|help|‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠)/i], t)) return 'help';
      if (has([/(‡πÄ‡∏õ‡∏¥‡∏î.*(‡πÄ‡∏ß‡∏•‡∏≤|‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô)|‡πÄ‡∏ß‡∏•‡∏≤.?‡πÄ‡∏õ‡∏¥‡∏î|‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£|‡∏õ‡∏¥‡∏î.*(‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á|‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô)|‡∏£‡πâ‡∏≤‡∏ô.*(‡πÄ‡∏õ‡∏¥‡∏î|‡∏õ‡∏¥‡∏î).*‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏´‡∏ô)/i], t)) return 'ask_hours';
      if (has([/(‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏ô|‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà|‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà|‡∏ó‡∏≤‡∏á‡πÑ‡∏õ|‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÑ‡∏õ.*‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô|‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á|map|where|address|location|‡∏û‡∏¥‡∏Å‡∏±‡∏î(‡∏£‡πâ‡∏≤‡∏ô)?|‡πÇ‡∏•‡πÄ‡∏Ñ(‡∏ä‡∏±‡∏ô|‡∏ä‡∏±‡πà‡∏ô))/i], t)) return 'ask_location';
      if (has([/(‡∏ô‡∏≥‡∏ó‡∏≤‡∏á|direction|navigate)/i], t)) return 'navigate';
      if (has([/(‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠|‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡∏£‡πå|‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡∏£‡πÇ‡∏ó‡∏£|phone|call|number)/i], t)) return 'ask_contact';
      if (has([/(‡πÇ‡∏õ‡∏£(‡πÇ‡∏°‡∏ä‡∏±‡∏ô|‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô)?|‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î|promo|promotion|discount|deal|coupon)/i], t)) return 'ask_promo';
      if (has([/(‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£|‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô|‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£)/i], t)) return 'ask_name';
      if (has([/(‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß|‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞|‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°|‡∏à‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô|‡∏à‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á|reserve|reservation|book( a)? table)/i], t)) return 'ask_booking';
      if (has([/(‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ|‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|recommended|what do you recommend|‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ|‡∏Ç‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏ô‡πà‡∏≠‡∏¢|‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)/i], t)) return 'recommend';
      if (has([/(‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|all menu|show all|everything)/i], t)) return 'show_all';
      if (has([/(‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏¥‡∏ô(‡∏ö‡πâ‡∏≤‡∏á|‡∏°‡∏±‡πà‡∏á|‡∏°‡∏±‡πâ‡∏á)?|‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£(‡∏Å‡∏¥‡∏ô)?‡∏ö‡πâ‡∏≤‡∏á|‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏¥‡∏ô|‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ|‡πÄ‡∏°‡∏ô‡∏π|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π|‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô|‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£|‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∞‡πÑ‡∏£|menu|recommend|dishes|‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ß|‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡πâ‡∏≥|‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°|‡∏ô‡πâ‡∏≥‡∏≠‡∏∞‡πÑ‡∏£|‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô|‡πÄ‡∏™‡πâ‡∏ô|‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß|‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà|‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô)/i], t)) return 'ask_menu';
      if (has([/(‡∏£‡∏≤‡∏Ñ‡∏≤|‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó|‡∏á‡∏ö|‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|price|how much|budget|under)/i], t)) return 'ask_price';
      if (has([/(‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡πÑ‡∏´‡∏°|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô|‡∏≠‡∏∑‡πà‡∏ô‡πÜ|‡∏≠‡∏∑‡πà‡∏ô ‡πÜ|more|more options|something else|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°|‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ|‡∏ï‡πà‡∏≠‡πÑ‡∏õ|‡∏ñ‡∏±‡∏î‡πÑ‡∏õ|next( page)?|‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤(‡∏ñ‡∏±‡∏î‡πÑ‡∏õ|‡∏ï‡πà‡∏≠‡πÑ‡∏õ)(‡πÄ‡∏•‡∏¢)?|‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ(‡πÄ‡∏•‡∏¢)?)/i], t)) return 'more';
      if (has([/(‡∏ó‡∏≥‡πÑ‡∏°|why|‡∏á‡∏á|‡πÄ‡∏≠‡πâ‡∏≤)/i], t)) return 'explain';
      if (has([/(‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç|‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà|reset|clear)/i], t)) return 'clear_filters';
      if (has([/(‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö|‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏á‡∏ö|‡∏•‡∏∑‡∏°‡∏á‡∏ö|‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏á‡∏ö|no budget)/i], t)) return 'clear_budget';
      if (findItemByName(t)) return 'ask_dish';
      if (parseMood(t)) return 'ask_menu';
      return 'unknown';
    }

    // ===== Menu filtering & helpers =====
    function findMenu({budget=null,taste=null,category=null,veg=null,excludeCategories=[],tags=[]}){
      let items=[...STORE.menu];
      if (budget!=null) items=items.filter(m=>m.price<=budget);
      if (taste){
        if (taste==='‡∏´‡∏ß‡∏≤‡∏ô') items=items.filter(m=>m.category==='‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô');
        else items=items.filter(m=>m.spicy===taste);
      }
      if (category) items=items.filter(m=>m.category===category);
      if (veg===true) items=items.filter(m=>m.veg);
      if (veg===false) items=items.filter(m=>!m.veg);
      if (excludeCategories.length) items=items.filter(m=>!excludeCategories.includes(m.category));
      if (tags && tags.length) items=items.filter(m=>(m.tags||[]).some(t=>tags.includes(t)));
      return items;
    }
    function cheapestFor({taste=null,category=null,veg=null,tags=[]}){
      const items = findMenu({budget:null,taste,category,veg,tags});
      if (!items.length) return null;
      const sorted=[...items].sort((a,b)=>a.price-b.price);
      return sorted[0];
    }
    function pageItems(arr, page=0){ const start = page*PAGE_SIZE; return arr.slice(start, start+PAGE_SIZE); }
    function formatMenu(items, prefix=''){
      if (!items.length) return '‡∏¢‡∏±‡∏á‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ü‡∏•/‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡∏î‡∏µ‡πÉ‡∏à), ‡∏´‡∏°‡∏ß‡∏î (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ß/‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°), ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô‚Äù, ‡∏á‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‚Äù';
      const top=items.map(m=>`‚Ä¢ ${m.name} ‚Äì ${m.price} ‡∏ö‡∏≤‡∏ó`).join('<br>');
      return prefix+top+(items.length>=PAGE_SIZE?'<br><span class="text-xs text-slate-500">‡∏û‡∏¥‡∏°‡∏û‡πå: "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°</span>':'');
    }

    // Mood ranking per spec
    function moodSort(items, mood){
      if (!mood) return items;
      const score = (m)=>{
        const tags = m.tags||[];
        if (mood==='tired') return (tags.includes('light')||tags.includes('‡πÄ‡∏ö‡∏≤')||tags.includes('‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢'))?3: (tags.includes('comfort')?2:0);
        if (mood==='happy') return (tags.includes('celebrate')?3: (m.category==='‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô'?2:0));
        if (mood==='sad') return (tags.includes('comfort')?3: (m.category==='‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô'?2:0));
        if (mood==='neutral') return 0;
        return 0;
      };
      return [...items].sort((a,b)=>score(b)-score(a) || a.price-b.price);
    }

    function suggestAlternatives(reasonMsg=''){
      const s = CTX.slots;
      let base = findMenu({budget:s.budget, category:s.category, veg:s.veg, tags:s.tags, excludeCategories:s.excludeCategories});
      base = moodSort(base, s.mood);
      const alt = base.filter(m=>!CTX.filtered.includes(m)).slice(0,PAGE_SIZE);
      if (alt.length){
        const pref=(reasonMsg? reasonMsg+'<br>':'')+'‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå:<br>';
        return formatMenu(alt, pref);
      }
      let cheapest = moodSort([...STORE.menu], s.mood).slice(0,PAGE_SIZE);
      return formatMenu(cheapest, (reasonMsg? reasonMsg+'<br>':'')+'‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:<br>');
    }

    // ===== Recommendation =====
    function doRecommend(inputNow){
      const now = parseSlots(inputNow);
      const params = {
        budget: (now.budget!=null ? now.budget : null),
        taste: (now.taste ? now.taste : null),
        category: (now.category ? now.category : null),
        veg: (now.veg!=null ? now.veg : CTX.slots.veg),
        tags: (now.tags && now.tags.length? now.tags : CTX.slots.tags),
      };
      let pool = findMenu(params);
      if (!pool.length) pool = findMenu({budget:params.budget, category:params.category, veg:params.veg, tags:params.tags});
      if (!pool.length) pool = [...STORE.menu];
      pool = moodSort(pool, CTX.slots.mood);
      // diversify picks
      const picks=[];
      for (const m of pool){ if (picks.length>=PAGE_SIZE) break; if (!picks.some(x=>x.name===m.name)) picks.push(m); }
      CTX.filtered = picks; CTX.page = 0;
      const moodLabel = CTX.slots.mood ? ` (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ${CTX.slots.mood})` : '';
      return formatMenu(CTX.filtered, '‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'+moodLabel+':<br>');
    }

    // ===== Budget prompting =====
    function shouldAskBudget(){
      const temp = findMenu({budget:null, taste:CTX.slots.taste, category:CTX.slots.category, veg:CTX.slots.veg, tags:CTX.slots.tags, excludeCategories:CTX.slots.excludeCategories});
      return temp.length>PAGE_SIZE;
    }

    // ===== Responders =====
    const RESP = {
      greet: ()=>'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ TasteCare ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì üíó ‡∏ö‡∏≠‡∏Å ‚Äú‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏á‚Äù + ‚Äú‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞',
      help: ()=>'‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå (‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡∏î‡∏µ‡πÉ‡∏à/‡πÄ‡∏®‡∏£‡πâ‡∏≤/‡πÄ‡∏â‡∏¢ ‡πÜ) + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏≤‡∏Å (‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô/‡πÄ‡∏ú‡πá‡∏î/‡πÄ‡∏à/‡∏á‡∏ö X) ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ü‡∏• ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô ‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù, ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‚Äù, ‚Äú‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö/‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‚Äù',
      ask_hours: ()=> STORE.meta.hours,
      ask_location: ()=> `‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${STORE.meta.address}<br>‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${STORE.meta.lat.toFixed(4)}, ${STORE.meta.lng.toFixed(4)}<br>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: <a class="underline" target="_blank" href="${STORE.meta.mapsUrl}">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a>`,
      ask_contact: ()=> `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà ${STORE.meta.phone}`,
      ask_promo: ()=> STORE.promos.length? STORE.promos.map(p=>`‚Ä¢ ${p.title} ‚Äì ${p.desc}`).join('<br>') : '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏Ñ‡πà‡∏∞',
      navigate: ()=> '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á...',
      ask_name: ()=> `‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤: <b>${STORE.meta.name}</b>`,
      ask_booking: ()=> `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡πà‡∏∞ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà <b>${STORE.meta.phone}</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏î‡πâ`,
      explain: ()=>{
        const s = CTX.slots;
        const parts = [
          (s.mood? `‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ${s.mood}`:''),
          (s.budget!=null? `‡∏á‡∏ö ‚â§ ${s.budget}`:''),
          (s.taste? `‡∏£‡∏™: ${s.taste}`:''),
          (s.category? `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${s.category}`:''),
          (s.tags && s.tags.length? `‡πÅ‡∏ó‡πá‡∏Å: ${s.tags.join('/')}`:''),
          (s.veg===true? `‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥`:''),
          (s.veg===false? `‡πÑ‡∏°‡πà‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥`:'')
        ].filter(Boolean);
        const msg = parts.length? `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (${parts.join(' ‚Ä¢ ')}) ‡∏Ñ‡πà‡∏∞`:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡πà‡∏∞';
        return msg + '<br>‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞';
      },
      clear_filters: ()=>{ CTX.slots={ budget:null, taste:null, category:null, veg:null, excludeCategories:[], tags:[], mood:null }; CTX.ttl={budget:0,taste:0,category:0,veg:0,mood:0}; CTX.filtered=[]; CTX.page=0; CTX.justChangedCategory=false; return '‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ üëç'; },
      clear_budget: ()=>{ CTX.slots.budget=null; CTX.ttl.budget=0; return '‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ (‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏á‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ)'; },
      show_all: ()=>{ CTX.last_intent='ask_menu'; CTX.page=0; CTX.filtered=[...STORE.menu]; const page=pageItems(CTX.filtered,0); return formatMenu(page,'‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏ô‡πâ‡∏≤ 1):<br>'); },
      ack: ()=> '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ üòä ‡∏™‡∏ô‡πÉ‡∏à‡∏î‡∏π "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞',
    };

    // ===== Core logic =====
    function doAskMenu(){
      if (CTX.justChangedCategory && CTX.slots.budget==null){
        CTX.justChangedCategory=false;
        return `‡∏´‡∏°‡∏ß‡∏î: ${CTX.slots.category}<br>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà${P.ask}?`;
      }
      let needBudget = (CTX.slots.budget==null) && shouldAskBudget();
      if (needBudget){ return `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà${P.ask}?`; }

      CTX.filtered = findMenu(CTX.slots);
      CTX.filtered = moodSort(CTX.filtered, CTX.slots.mood);
      CTX.page=0;

      const page = pageItems(CTX.filtered, 0);
      if (!page.length){
        let reason = '';
        const cheapMood = cheapestFor({category:CTX.slots.category, veg:CTX.slots.veg, tags:CTX.slots.tags});
        if (CTX.slots.budget!=null && cheapMood && CTX.slots.budget < cheapMood.price){
          reason = `‡∏á‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà ${cheapMood.price} ‡∏ö‡∏≤‡∏ó: ${cheapMood.name})`;
        }
        return suggestAlternatives(reason);
      }

      const prefix = [
        (CTX.slots.mood? `‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ${CTX.slots.mood}<br>`:''),
        (CTX.slots.tags && CTX.slots.tags.length? `‡πÅ‡∏ó‡πá‡∏Å: ${CTX.slots.tags.join('/')}<br>`:''),
        (CTX.slots.budget!=null? `‡∏á‡∏ö ‚â§ ${CTX.slots.budget} ‡∏ö‡∏≤‡∏ó<br>`:''),
        (CTX.slots.taste? `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ${CTX.slots.taste}<br>`:''),
        (CTX.slots.category? `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${CTX.slots.category}<br>`:''),
        (CTX.slots.veg===true? `‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥: ‡πÉ‡∏ä‡πà<br>`:''),
        (CTX.slots.veg===false? `‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥: ‡πÑ‡∏°‡πà<br>`:'')
      ].join('');
      return formatMenu(page, prefix);
    }

    function route(input){
      METRICS.total++;
      const raw = input||'';
      const norm = normalize(raw);

      // Contact fast-path
      if (/(‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠|‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡∏£‡πå|‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡∏£‡πÇ‡∏ó‡∏£|phone|call|number)/i.test(norm)){
        METRICS.ok++; return RESP.ask_contact();
      }

      // "‡∏°‡∏µ X ‡πÑ‡∏´‡∏°"
      let mExist = norm.match(/^‡∏°‡∏µ\s*([^?]+?)(\s*(‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á|‡∏ö‡πâ‡∏≤‡∏á|‡∏°‡∏±‡πâ‡∏¢|‡πÑ‡∏´‡∏°|‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤|‡∏õ‡∏∞))?\s*$/);
      if (mExist){
        const q = mExist[1].trim();
        if (/(‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ß|‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡πâ‡∏≥|‡∏ô‡πâ‡∏≥(‡∏î‡∏∑‡πà‡∏°)?|(^|\s)‡∏ô‡πâ‡∏≥(\s|$)|‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô|‡πÄ‡∏™‡πâ‡∏ô|‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß|‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà|‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô)/i.test(q)){
          const parsed = parseSlots(q);
          applyTTL(parsed);
          METRICS.ok++; return doAskMenu();
        }
        const dish = findItemByName(q);
        METRICS.ok++;
        if (dish) return `‡∏°‡∏µ‡∏Ñ‡πà‡∏∞: <b>${dish.name}</b> ‚Äì ${dish.price} ‡∏ö‡∏≤‡∏ó ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ú‡πá‡∏î: ${dish.spicy}${dish.veg? ' ‚Ä¢ ‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥':''}`;
        return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞';
      }

      // "X ‡πÄ‡∏ú‡πá‡∏î‡πÑ‡∏´‡∏°"
      let mSpicy = norm.match(/(.+?)(‡∏ô‡∏µ‡πà|‡∏ô‡∏µ‡πâ)?\s*‡πÄ‡∏ú‡πá‡∏î(‡πÑ‡∏´‡∏°|‡∏°‡∏±‡πâ‡∏¢)\s*$/);
      if (mSpicy){
        const q = mSpicy[1].trim();
        const dish = findItemByName(q);
        METRICS.ok++;
        if (dish) return `${dish.name} ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ú‡πá‡∏î: <b>${dish.spicy}</b> ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ ${dish.price} ‡∏ö‡∏≤‡∏ó`;
        return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞';
      }

      // "X ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ß‡πÑ‡∏´‡∏°/‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏´‡∏°/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÑ‡∏´‡∏°"
      let mKind = norm.match(/(.+?)\s*(‡∏Ñ‡∏∑‡∏≠)?\s*(‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ß|‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°)\s*(‡πÑ‡∏´‡∏°|‡∏°‡∏±‡πâ‡∏¢)\s*$/);
      if (mKind){
        const q = mKind[1].trim();
        const dish = findItemByName(q);
        METRICS.ok++;
        if (dish){
          const ans = (dish.category === mKind[3]) ? '‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏∞' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏∞';
          return `${ans} ‚Ä¢ ${dish.name} ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î: <b>${dish.category}</b>`;
        }
        return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞';
      }

      // intents + slots
      const intent = matchIntent(norm);
      const parsed = parseSlots(norm);
      applyTTL(parsed);

      if (['greet','help','ask_hours','ask_location','ask_contact','ask_promo','navigate','explain','clear_filters','clear_budget','show_all','ack','ask_name','ask_booking'].includes(intent)){
        METRICS.ok++; CTX.last_intent=intent; return RESP[intent]();
      }
      if (intent==='recommend'){ METRICS.ok++; CTX.last_intent='recommend'; return doRecommend(norm); }
      if (intent==='more'){
        if (CTX.filtered.length){
          const next = pageItems(CTX.filtered, ++CTX.page);
          if (next.length){ METRICS.ok++; CTX.last_intent='ask_menu'; return formatMenu(next, `‡∏´‡∏ô‡πâ‡∏≤ ${CTX.page+1}:<br>`); }
          METRICS.ok++; return suggestAlternatives();
        }
        METRICS.fallback++; return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå "‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" ‡∏Å‡πà‡∏≠‡∏ô';
      }
      if (intent==='ask_dish'){
        const dish = findItemByName(norm);
        METRICS.ok++;
        if (dish) return `${dish.name} ‚Äì ${dish.price} ‡∏ö‡∏≤‡∏ó ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ú‡πá‡∏î: ${dish.spicy}${dish.veg? ' ‚Ä¢ ‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥':''}`;
        return doAskMenu(); // fallback to menu
      }
      if (intent==='ask_menu' || intent==='ask_price'){ CTX.last_intent='ask_menu'; METRICS.ok++; return doAskMenu(); }

      METRICS.fallback++;
      return '‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡∏•‡∏≠‡∏á‡∏ö‡∏≠‡∏Å ‚Äú‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ü‡∏•/‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡∏î‡∏µ‡πÉ‡∏à/‡πÄ‡∏â‡∏¢ ‡πÜ‚Äù ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏≤‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô ‡∏á‡∏ö 80‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡πà‡∏∞';
    }

    // ===== UI wiring =====
    const inputEl=document.getElementById('input');
    const sendBtn=document.getElementById('send');
    const quickBar=document.getElementById('quickbar');

    function sendText(text){ if(!text) return; addMsg('user', text); const res=route(text); addMsg('bot', res); updateMetrics(); }
    sendBtn.addEventListener('click',()=>{ const t=inputEl.value.trim(); inputEl.value=''; sendText(t); });
    inputEl.addEventListener('keydown',e=>{
      if ((e.ctrlKey||e.metaKey) && e.key==='Enter') sendBtn.click();
      if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
    });
    document.getElementById('btnHelp').onclick=()=>sendText('help');
    document.getElementById('btnClear').onclick=()=>{ document.getElementById('chat').innerHTML=''; CTX.last_intent=null; CTX.slots={budget:null,taste:null,category:null,veg:null,excludeCategories:[],tags:[],mood:null}; CTX.ttl={budget:0,taste:0,category:0,veg:0,mood:0}; CTX.filtered=[]; CTX.page=0; CTX.justChangedCategory=false; greet(); };

    function renderQuick(){
      const qs=[
        {label:'‡πÄ‡∏ü‡∏• + ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô', text:'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ü‡∏• ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡πâ‡∏ô ‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80'},
        {label:'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≤ ‡πÜ', text:'‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‡∏Ç‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏ö‡∏≤ ‡πÜ'},
        {label:'‡∏î‡∏µ‡πÉ‡∏à ‡∏≠‡∏¢‡∏≤‡∏Å‡∏â‡∏•‡∏≠‡∏á', text:'‡∏î‡∏µ‡πÉ‡∏à ‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô ‡∏≠‡∏¢‡∏≤‡∏Å‡∏â‡∏•‡∏≠‡∏á'},
        {label:'‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î', text:'‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î ‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 70'},
        {label:'‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', text:'‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥'},
        {label:'‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', text:'‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'},
        {label:'‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö', text:'‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö'},
        {label:'‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', text:'‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç'}
      ];
      quickBar.innerHTML='';
      qs.forEach(q=>{ const b=document.createElement('button'); b.className='text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200'; b.textContent=q.label; b.onclick=()=>sendText(q.text); quickBar.appendChild(b); });
    }

    function renderStoreInfo(){
      const el=document.getElementById('storeInfo');
      el.innerHTML = `
        <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:</b> ${STORE.meta.name}</div>
        <div><b>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</b> ${STORE.meta.hours} (Open daily 10:00‚Äì20:00)</div>
        <div><b>‡πÇ‡∏ó‡∏£:</b> ${STORE.meta.phone}</div>
        <div><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${STORE.meta.address}</div>
        <div><b>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô:</b><br>${STORE.promos.map(p=>`‚Ä¢ ${p.title} ‚Äì ${p.desc}`).join('<br>')}</div>
      `;
      document.getElementById('mapsLink').href=STORE.meta.mapsUrl;
      document.getElementById('btnNavigate').onclick=()=>addMsg('bot','‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞');
      document.getElementById('btnShowMenu').onclick=()=>sendText('‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    }

    function addMsg(role, html){
      const wrap=document.createElement('div');
      const isUser=role==='user';
      wrap.className='flex '+(isUser?'justify-end':'justify-start');
      const bubble=document.createElement('div');
      bubble.className='max-w-[85%] rounded-2xl px-4 py-2 shadow '+(isUser?'bg-pink-600 text-white rounded-br-md':'bg-white border border-slate-200 rounded-bl-md');
      bubble.innerHTML=html;
      document.getElementById('chat').appendChild(wrap).appendChild(bubble);
      document.getElementById('chat').scrollTo({top:document.getElementById('chat').scrollHeight,behavior:'smooth'});
    }

    const METRICS={total:0,ok:0,fallback:0};
    function updateMetrics(){
      const cov = METRICS.total? Math.round(((METRICS.total-METRICS.fallback)/METRICS.total)*100):0;
      document.getElementById('m_total').textContent=METRICS.total;
      document.getElementById('m_ok').textContent=METRICS.ok;
      document.getElementById('m_fb').textContent=METRICS.fallback;
      document.getElementById('m_cov').textContent=cov+'%';
    }

    function greet(){ addMsg('bot','‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ TasteCare ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì üíó ‡∏ö‡∏≠‡∏Å ‚Äú‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏á‚Äù + ‚Äú‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞'); }
    function init(){ document.getElementById('lang').value='th'; renderQuick(); renderStoreInfo(); greet(); }
    init();
  </script>
</body>
</html>
