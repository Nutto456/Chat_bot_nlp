<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restaurant Assistant Chatbot ‚Äì Smarter v2.3 (TH/EN)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nice-scrollbar::-webkit-scrollbar{width:8px;height:8px}
    .nice-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
    .nice-scrollbar{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
  <div class="min-h-screen max-w-4xl mx-auto p-4 md:p-8">
    <header class="mb-4">
      <div class="rounded-2xl bg-gradient-to-r from-indigo-500 via-sky-500 to-cyan-400 text-white p-6 shadow-lg flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold">üçú Restaurant Assistant Chatbot ‚Äì <span class="font-bold">Smarter v2.3</span></h1>
          <p class="opacity-95 mt-1">Lexical ‚Ä¢ Syntactic ‚Ä¢ Semantic ‚Ä¢ Pagination ‚Ä¢ <b>Recommendation mode</b></p>
          <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
            <span class="bg-white/15 px-2.5 py-1 rounded-full">TH/EN</span>
            <span class="bg-white/15 px-2.5 py-1 rounded-full">Context & Slot Control</span>
            <span class="bg-white/15 px-2.5 py-1 rounded-full">Regex + Light Semantics</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="lang" class="text-sm opacity-90">‡∏†‡∏≤‡∏©‡∏≤ / Language</label>
          <select id="lang" class="text-sm rounded-lg px-2 py-1 text-slate-800 bg-white/90">
            <option value="th">‡πÑ‡∏ó‡∏¢ (TH)</option>
            <option value="en">English (EN)</option>
          </select>
        </div>
      </div>
    </header>

    <main class="grid md:grid-cols-3 gap-4">
      <section class="md:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-sky-400 grid place-items-center text-white">ü§ñ</div>
              <div>
                <div class="font-semibold leading-tight">‡∏ö‡∏≠‡∏ó‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)</div>
                <div class="text-xs text-slate-500">‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢ / help‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnClear" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó</button>
              <button id="btnHelp" class="text-xs px-3 py-1.5 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100">‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
            </div>
          </div>

          <div id="chat" class="h-[56vh] md:h-[62vh] overflow-y-auto nice-scrollbar p-4 space-y-3"></div>

          <div class="border-t border-slate-200 p-3">
            <div class="flex items-end gap-2">
              <div class="flex-1">
                <textarea id="input" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‚Äò‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‚Äô, ‚Äò‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏´‡∏ô‚Äô, ‚Äò‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äô, ‚Äò‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô 60‚Äô, ‚Äòveg‚Äô, ‚Äò‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‚Äô, ‚Äò‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‚Äô ..." class="w-full resize-none rounded-xl border-slate-300 focus:border-indigo-400 focus:ring-indigo-300"></textarea>
                <div id="quickbar" class="flex flex-wrap gap-2 mt-2 text-sm"></div>
              </div>
              <button id="send" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 active:scale-[.99]">‡∏™‡πà‡∏á</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="md:col-span-1 space-y-4">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4">
          <h2 class="font-semibold mb-2">üß™ Metrics</h2>
          <ul class="text-sm space-y-1" id="metrics">
            <li>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="m_total">0</b></li>
            <li>‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b id="m_ok">0</b></li>
            <li>Fallback: <b id="m_fb">0</b></li>
            <li>Coverage ‚âà <b id="m_cov">0%</b></li>
          </ul>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4">
          <h2 class="font-semibold mb-2">‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</h2>
          <div class="text-sm leading-6" id="storeInfo"></div>
          <div class="mt-3 flex flex-wrap gap-2">
            <a id="mapsLink" target="_blank" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
            <button id="btnNavigate" class="text-xs px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô</button>
            <button id="btnShowMenu" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200">‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Menu Modal -->
  <div id="menuModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm grid place-items-center p-4">
    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
        <h3 class="font-semibold">üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <button id="closeMenu" class="text-slate-500 hover:text-slate-700">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex items-center gap-2">
          <input id="menuSearch" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‚Äò‡πÄ‡∏ú‡πá‡∏î‚Äô, ‚Äò‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô‚Äô, ‚Äò< 100‚Äô, ‚Äòveg‚Äô" class="w-full rounded-lg border-slate-300 focus:border-indigo-400 focus:ring-indigo-300" />
          <button id="menuSearchBtn" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
        <div id="menuList" class="grid sm:grid-cols-2 gap-3"></div>
      </div>
    </div>
  </div>

  <script>
    const PAGE_SIZE = 6;

    const STORE = {
      meta: {
        name: "‡∏Ñ‡∏£‡∏±‡∏ß‡∏£‡∏¥‡∏°‡∏ó‡∏≤‡∏á",
        hours: "‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô 10:00‚Äì20:00 ‡∏ô.",
        phone: "081-234-5678",
        address: "‡∏ã‡∏≠‡∏¢ A ‡∏ñ‡∏ô‡∏ô B ‡∏ï‡∏¥‡∏î C ‡πÅ‡∏Ç‡∏ß‡∏á/‡πÄ‡∏Ç‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£",
        mapsUrl: "https://maps.google.com/?q=13.7563,100.5018",
        lat: 13.7563, lng: 100.5018,
      },
      promos: [
        { title: "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 10%", desc: "‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏à.-‡∏û‡∏§." },
        { title: "Member Stamp 8 ‡∏ü‡∏£‡∏µ 1", desc: "‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏ï‡∏°‡∏õ‡πå‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" },
      ],
      menu: [
        { name: "‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á", price: 120, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false },
        { name: "‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏Å‡∏∏‡πâ‡∏á‡∏™‡∏î", price: 80, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: false },
        { name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π", price: 60, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: false },
        { name: "‡∏™‡πâ‡∏°‡∏ï‡∏≥‡πÑ‡∏ó‡∏¢", price: 60, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡πÄ‡∏ú‡πá‡∏î", veg: false },
        { name: "‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏Å‡πà", price: 95, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: false },
        { name: "‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ", price: 65, category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", spicy: "‡∏Å‡∏•‡∏≤‡∏á", veg: true },
        { name: "‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡∏ß‡∏≤‡∏ô‡∏¥‡∏•‡∏•‡∏≤", price: 45, category: "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true },
        { name: "‡∏ä‡∏≤‡∏ô‡∏°‡πÄ‡∏¢‡πá‡∏ô", price: 35, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true },
        { name: "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏¢‡πá‡∏ô", price: 35, category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", spicy: "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î", veg: true },
      ],
    };

    function normalize(s){ return s.toLowerCase().trim(); }
    function parseBudget(text){
      const map={'‡πê':0,'‡πë':1,'‡πí':2,'‡πì':3,'‡πî':4,'‡πï':5,'‡πñ':6,'‡πó':7,'‡πò':8,'‡πô':9};
      const t=text.replace(/[‡πê-‡πô]/g,d=>map[d]);
      const m=t.match(/\d{2,4}/);
      return m?parseInt(m[0],10):null;
    }
    function has(pats, t){ return pats.some(p=>p.test(t)); }

    function parseSlots(text){
      const t = normalize(text);
      const slots = {};
      if (/(‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î|‡∏Å‡∏¥‡∏ô‡πÄ‡∏ú‡πá‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ|‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢|mild)/i.test(t)) slots.taste = '‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î';
      else if (/(‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á|‡∏Å‡∏•‡∏≤‡∏á|medium)/i.test(t)) slots.taste = '‡∏Å‡∏•‡∏≤‡∏á';
      else if (/(‡πÄ‡∏ú‡πá‡∏î|‡∏à‡∏±‡∏î|spicy|hot)/i.test(t)) slots.taste = '‡πÄ‡∏ú‡πá‡∏î';
      if (/(‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|dessert)/i.test(t)) slots.category = '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô';
      else if (/(‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|drink|beverage)/i.test(t)) slots.category = '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°';
      if (/(‡πÄ‡∏à|‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥|veg|vegetarian|‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)/i.test(t)) slots.veg = true;
      if (/(‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ú‡∏±‡∏Å|no veg|‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å‡πÑ‡∏´‡∏°|‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏±‡∏Å)/i.test(t)) slots.veg = false;
      const b = parseBudget(t); if (b!=null) slots.budget=b;
      return slots;
    }

    const CTX = { last_intent:null, slots:{ budget:null, taste:null, category:null, veg:null }, filtered:[], page:0 };

    function matchIntent(text){
      const t = normalize(text);
      if (has([/(‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ|‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ|‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö+|‡∏î‡∏µ‡∏Ñ‡πà‡∏∞+|‡∏î‡∏µ‡∏Ñ‡∏±‡∏ö|‡∏î‡∏µ‡∏Ñ‡∏∞|‡∏î‡∏µ‡∏à‡πâ‡∏≤|hello|hi|hey)/i], t)) return 'greet';
      if (has([/(‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢|help|‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠)/i], t)) return 'help';
      if (has([/(‡πÄ‡∏õ‡∏¥‡∏î.*(‡πÄ‡∏ß‡∏•‡∏≤|‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô)|‡πÄ‡∏ß‡∏•‡∏≤.?‡πÄ‡∏õ‡∏¥‡∏î|‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£|‡∏õ‡∏¥‡∏î.*(‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á|‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô)|‡∏£‡πâ‡∏≤‡∏ô.*(‡πÄ‡∏õ‡∏¥‡∏î|‡∏õ‡∏¥‡∏î).*‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏´‡∏ô)/i], t)) return 'ask_hours';
      if (has([/(‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏ô|‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà|‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà|‡∏ó‡∏≤‡∏á‡πÑ‡∏õ|‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÑ‡∏õ.*‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô|‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á|map|where|address|location|‡∏û‡∏¥‡∏Å‡∏±‡∏î(‡∏£‡πâ‡∏≤‡∏ô)?|‡πÇ‡∏•‡πÄ‡∏Ñ(‡∏ä‡∏±‡∏ô|‡∏ä‡∏±‡πà‡∏ô))/i], t)) return 'ask_location';
      if (has([/(‡∏ô‡∏≥‡∏ó‡∏≤‡∏á|direction|navigate)/i], t)) return 'navigate';
      if (has([/(‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠|‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡∏£‡πå|contact|phone|call|number)/i], t)) return 'ask_contact';
      if (has([/(‡πÇ‡∏õ‡∏£(‡πÇ‡∏°‡∏ä‡∏±‡∏ô|‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô)?|‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î|promo|promotion|discount|deal|coupon)/i], t)) return 'ask_promo';
      if (has([/(‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£|‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô|‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£)/i], t)) return 'ask_name';
      if (has([/(‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß|‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞|‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°|‡∏à‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô|‡∏à‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á|reserve|reservation|book( a)? table)/i], t)) return 'ask_booking';
      if (has([/(‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ|‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|recommended|what do you recommend|‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ)/i], t)) return 'recommend';
      if (has([/(‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|all menu|show all|everything)/i], t)) return 'show_all';
      if (has([/(‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏¥‡∏ô(‡∏ö‡πâ‡∏≤‡∏á|‡∏°‡∏±‡πà‡∏á|‡∏°‡∏±‡πâ‡∏á)?|‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£(‡∏Å‡∏¥‡∏ô)?‡∏ö‡πâ‡∏≤‡∏á|‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏¥‡∏ô|‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ|‡πÄ‡∏°‡∏ô‡∏π|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π|‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô|‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£|‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∞‡πÑ‡∏£|menu|recommend|dishes)/i], t)) return 'ask_menu';
      if (has([/(‡∏£‡∏≤‡∏Ñ‡∏≤|‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó|‡∏á‡∏ö|‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|price|how much|budget|under)/i], t)) return 'ask_price';
      if (has([/(‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡πÑ‡∏´‡∏°|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô|‡∏≠‡∏∑‡πà‡∏ô‡πÜ|‡∏≠‡∏∑‡πà‡∏ô ‡πÜ|more|more options|something else|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°|‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ|‡∏ï‡πà‡∏≠‡πÑ‡∏õ|‡∏ñ‡∏±‡∏î‡πÑ‡∏õ|next( page)?|‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤(‡∏ñ‡∏±‡∏î‡πÑ‡∏õ|‡∏ï‡πà‡∏≠‡πÑ‡∏õ)(‡πÄ‡∏•‡∏¢)?|‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ(‡πÄ‡∏•‡∏¢)?)/i], t)) return 'more';
      if (has([/(‡∏ó‡∏≥‡πÑ‡∏°|why|‡∏á‡∏á|‡πÄ‡∏≠‡πâ‡∏≤)/i], t)) return 'explain';
      if (has([/(‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç|‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà|reset|clear)/i], t)) return 'clear_filters';
      if (has([/(‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö|‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏á‡∏ö|‡∏•‡∏∑‡∏°‡∏á‡∏ö|‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏á‡∏ö|no budget)/i], t)) return 'clear_budget';
      if (has([/(‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì(‡∏Ñ‡∏£‡∏±‡∏ö|‡∏Ñ‡πà‡∏∞)?|‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö|‡πÇ‡∏≠‡πÄ‡∏Ñ|ok|okay|thanks?|thx|‡πÑ‡∏î‡πâ(‡∏Ñ‡∏£‡∏±‡∏ö|‡∏Ñ‡πà‡∏∞)|‡∏Ñ‡∏£‡∏±‡∏ö‡∏ú‡∏°|‡∏Ñ‡πâ‡∏≤‡∏ö+|‡∏Ñ‡∏±‡∏ö|‡πÄ‡∏Ñ‡πÜ)/i], t)) return 'ack';
      if (/(‡πÄ‡∏ú‡πá‡∏î|‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î|‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|dessert|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|drink|veg|vegetarian)/i.test(t) || /\d{2,4}/.test(t)) return 'ask_menu';
      return 'unknown';
    }

    function findMenu({budget=null,taste=null,category=null,veg=null}){
      let items=[...STORE.menu];
      if (budget!=null) items=items.filter(m=>m.price<=budget);
      if (taste){
        if (taste==='‡∏´‡∏ß‡∏≤‡∏ô') items=items.filter(m=>m.category==='‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô');
        else items=items.filter(m=>m.spicy===taste);
      }
      if (category) items=items.filter(m=>m.category===category);
      if (veg===true) items=items.filter(m=>m.veg);
      if (veg===false) items=items.filter(m=>!m.veg);
      return items;
    }

    function pageItems(arr, page=0){
      const start = page*PAGE_SIZE;
      return arr.slice(start, start+PAGE_SIZE);
    }

    function formatMenu(items, prefix=''){
      if (!items.length) return '‡∏¢‡∏±‡∏á‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ ‚Äú‡πÄ‡∏ú‡πá‡∏î/‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î/‡∏Å‡∏•‡∏≤‡∏á‚Äù, ‚Äú‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‚Äù, ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80‚Äù';
      const top=items.map(m=>`‚Ä¢ ${m.name} ‚Äì ${m.price} ‡∏ö‡∏≤‡∏ó`).join('<br>');
      return prefix+top+(items.length>=PAGE_SIZE?'<br><span class="text-xs text-slate-500">‡∏û‡∏¥‡∏°‡∏û‡πå: "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°</span>':'');
    }

    function suggestAlternatives(){
      const s = CTX.slots;
      const base = findMenu({budget:s.budget, category:s.category, veg:s.veg});
      const alt = base.filter(m=>!CTX.filtered.includes(m)).slice(0,PAGE_SIZE);
      if (alt.length){
        const pref='‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥):<br>';
        return formatMenu(alt, pref);
      }
      const cheapest = [...STORE.menu].sort((a,b)=>a.price-b.price).slice(0,PAGE_SIZE);
      return formatMenu(cheapest, '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ:<br>');
    }

    function doRecommend(inputNow){
      const now = parseSlots(inputNow);
      const params = {
        budget: (now.budget!=null ? now.budget : null),
        taste: (now.taste ? now.taste : null),
        category: (now.category ? now.category : null),
        veg: (now.veg!=null ? now.veg : CTX.slots.veg)
      };
      let pool = findMenu(params);
      if (!pool.length){
        pool = findMenu({budget:params.budget, category:params.category, veg:params.veg});
      }
      if (!pool.length){
        pool = [...STORE.menu];
      }
      const by = (key,val)=>pool.find(m=>m[key]===val);
      const picks = [];
      const add = m => { if (m && !picks.includes(m)) picks.push(m); };
      add(by('spicy','‡πÄ‡∏ú‡πá‡∏î'));
      add(by('spicy','‡∏Å‡∏•‡∏≤‡∏á'));
      add(by('spicy','‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î'));
      add(pool.find(m=>m.category==='‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô'));
      add(pool.find(m=>m.category==='‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'));
      add(pool.find(m=>m.veg===true));
      for (const m of pool){ if (picks.length>=PAGE_SIZE) break; add(m); }
      CTX.filtered = picks;
      CTX.page = 0;
      return formatMenu(CTX.filtered, '‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:<br>');
    }

    const RESP = {
      greet: ()=>'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ? (‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π)',
      help: ()=>'‡∏â‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î, ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡∏û‡∏¥‡∏Å‡∏±‡∏î, ‡πÄ‡∏°‡∏ô‡∏π/‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÄ‡∏ú‡πá‡∏î/‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î/‡πÄ‡∏à/‡∏á‡∏ö), ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô, ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥, ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á, ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß, ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç/‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö, ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ"',
      ask_hours: ()=> STORE.meta.hours,
      ask_location: ()=> `‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${STORE.meta.address}<br>‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${STORE.meta.lat.toFixed(4)}, ${STORE.meta.lng.toFixed(4)}<br>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: <a class="underline" target="_blank" href="${STORE.meta.mapsUrl}">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a><br><button onclick="startNav()" class="mt-2 text-xs px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô</button>`,
      ask_contact: ()=> `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà ${STORE.meta.phone}`,
      ask_promo: ()=> STORE.promos.length? STORE.promos.map(p=>`‚Ä¢ ${p.title} ‚Äì ${p.desc}`).join('<br>') : '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô',
      navigate: ()=> startNav(true),
      ask_name: ()=> `‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤: <b>${STORE.meta.name}</b>`,
      ask_booking: ()=> `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà <b>${STORE.meta.phone}</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏î‡πâ`,
      explain: ()=>{
        const s = CTX.slots;
        const parts = [
          (s.budget!=null? `‡∏á‡∏ö ‚â§ ${s.budget}`:''),
          (s.taste? `‡∏£‡∏™: ${s.taste}`:''),
          (s.category? `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${s.category}`:''),
          (s.veg===true? `‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥`:''),
          (s.veg===false? `‡πÑ‡∏°‡πà‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥`:'')
        ].filter(Boolean);
        const msg = parts.length? `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (${parts.join(' ‚Ä¢ ')}) ‡πÄ‡∏•‡∏¢‡πÄ‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞`:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç';
        return msg + '<br>‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå: "‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç" ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"';
      },
      clear_filters: ()=>{ CTX.slots={ budget:null, taste:null, category:null, veg:null }; CTX.filtered=[]; CTX.page=0; return '‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ üëç'; },
      clear_budget: ()=>{ CTX.slots.budget=null; return '‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ (‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏á‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ)'; },
      show_all: ()=>{ CTX.last_intent='ask_menu'; CTX.page=0; CTX.filtered=[...STORE.menu]; const page=pageItems(CTX.filtered,0); return formatMenu(page,'‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏ô‡πâ‡∏≤ 1):<br>'); },
      ack: ()=> '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ üòä ‡∏™‡∏ô‡πÉ‡∏à‡∏î‡∏π "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÑ‡∏´‡∏°',
    };

    function startNav(silent){
      if (silent===true){ setTimeout(()=>startNav(),0); return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á...'; }
      if (!('geolocation' in navigator)){ bot('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'); return 'geolocation_not_supported'; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const origin = `${pos.coords.latitude},${pos.coords.longitude}`;
        const dest = `${STORE.meta.lat},${STORE.meta.lng}`;
        const url=`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=driving`;
        window.open(url,'_blank');
        bot(`‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß <a class="underline" target="_blank" href="${url}">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a> ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô`);
      }, _=> bot('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'),
      { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
      return 'opening_maps';
    }

    const chatEl=document.getElementById('chat');
    function addMsg(role, html){
      const wrap=document.createElement('div');
      const isUser=role==='user';
      wrap.className='flex '+(isUser?'justify-end':'justify-start');
      const bubble=document.createElement('div');
      bubble.className='max-w-[85%] rounded-2xl px-4 py-2 shadow '+(isUser?'bg-indigo-600 text-white rounded-br-md':'bg-white border border-slate-200 rounded-bl-md');
      bubble.innerHTML=html;
      wrap.appendChild(bubble); chatEl.appendChild(wrap);
      chatEl.scrollTo({top:chatEl.scrollHeight,behavior:'smooth'});
    }
    const bot = html => addMsg('bot', html);
    const user = html => addMsg('user', html);

    const METRICS={total:0,ok:0,fallback:0};
    function updateMetrics(){
      const cov = METRICS.total? Math.round(((METRICS.total-METRICS.fallback)/METRICS.total)*100):0;
      document.getElementById('m_total').textContent=METRICS.total;
      document.getElementById('m_ok').textContent=METRICS.ok;
      document.getElementById('m_fb').textContent=METRICS.fallback;
      document.getElementById('m_cov').textContent=cov+'%';
    }

    function needMoreSlots(slots){
      if (slots.category==null && slots.veg==null && slots.taste==null && slots.budget==null)
        return '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô (‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°), ‡πÄ‡∏ú‡πá‡∏î‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô, ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à/‡∏°‡∏±‡∏á‡∏Ø ‡πÑ‡∏´‡∏°?';
      if (slots.budget==null) return '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞?';
      return null;
    }

    function doAskMenu(){
      const ask = needMoreSlots(CTX.slots);
      if (ask){ METRICS.ok++; return ask; }
      CTX.filtered = findMenu(CTX.slots);
      CTX.page=0;
      const prefix = [
        (CTX.slots.budget!=null? `‡∏á‡∏ö ‚â§ ${CTX.slots.budget} ‡∏ö‡∏≤‡∏ó<br>`:''),
        (CTX.slots.taste? `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ${CTX.slots.taste}<br>`:''),
        (CTX.slots.category? `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${CTX.slots.category}<br>`:''),
        (CTX.slots.veg===true? `‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥: ‡πÉ‡∏ä‡πà<br>`:''),
        (CTX.slots.veg===false? `‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥: ‡πÑ‡∏°‡πà<br>`:'')
      ].join('');
      const page = pageItems(CTX.filtered, 0);
      if (!page.length){
        METRICS.ok++; 
        return suggestAlternatives();
      }
      METRICS.ok++;
      return formatMenu(page, prefix);
    }

    function route(input){
      METRICS.total++;
      const norm = normalize(input);
      let intent = matchIntent(norm);

      const parsed = parseSlots(norm);
      for (const k of Object.keys(parsed)){ CTX.slots[k] = parsed[k]; }

      if (['greet','help','ask_hours','ask_location','ask_contact','ask_promo','navigate','explain','clear_filters','clear_budget','show_all','ack','ask_name','ask_booking'].includes(intent)){
        METRICS.ok++; CTX.last_intent=intent; return RESP[intent]();
      }

      if (intent==='recommend'){
        METRICS.ok++; CTX.last_intent='recommend';
        return doRecommend(norm);
      }

      if (intent==='more'){
        if (CTX.filtered.length){
          const next = pageItems(CTX.filtered, ++CTX.page);
          if (next.length){ METRICS.ok++; CTX.last_intent='ask_menu'; return formatMenu(next, `‡∏´‡∏ô‡πâ‡∏≤ ${CTX.page+1}:<br>`); }
          METRICS.ok++; return suggestAlternatives();
        }
        METRICS.fallback++; return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå "‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" ‡∏Å‡πà‡∏≠‡∏ô';
      }

      if (intent==='ask_menu' || intent==='ask_price'){
        CTX.last_intent='ask_menu';
        return doAskMenu();
      }

      METRICS.fallback++;
      return '‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå: ‚Äú‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢‚Äù, ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‚Äù, ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù, ‚Äú‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡∏û‡∏¥‡∏Å‡∏±‡∏î‚Äù, ‚Äú‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏ú‡πá‡∏î‡πÜ‚Äù, ‚Äú‡∏á‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80‚Äù, ‡∏´‡∏£‡∏∑‡∏≠ ‚Äúveg‚Äù';
    }

    const inputEl=document.getElementById('input');
    const sendBtn=document.getElementById('send');
    const quickBar=document.getElementById('quickbar');

    function sendText(text){ if(!text) return; user(text); const res=route(text); bot(res); updateMetrics(); }
    sendBtn.addEventListener('click',()=>{ const t=inputEl.value.trim(); inputEl.value=''; sendText(t); });
    inputEl.addEventListener('keydown',e=>{
      if ((e.ctrlKey||e.metaKey) && e.key==='Enter') sendBtn.click();
      if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
    });
    document.getElementById('btnHelp').onclick=()=>sendText('help');
    document.getElementById('btnClear').onclick=()=>{ chatEl.innerHTML=''; CTX.last_intent=null; CTX.slots={budget:null,taste:null,category:null,veg:null}; CTX.filtered=[]; CTX.page=0; greet(); };

    function renderQuick(){
      const qs=[
        {label:'‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', text:'‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥'},
        {label:'‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', text:'‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'},
        {label:'‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô 60', text:'‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô 60'},
        {label:'veg', text:'‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏à‡πÑ‡∏´‡∏°'},
        {label:'‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡∏û‡∏¥‡∏Å‡∏±‡∏î', text:'‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô'},
        {label:'‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô', text:'‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£'},
        {label:'‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß', text:'‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°'},
        {label:'‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ', text:'‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ'},
        {label:'‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö', text:'‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏ö'}
      ];
      quickBar.innerHTML='';
      qs.forEach(q=>{ const b=document.createElement('button'); b.className='text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200'; b.textContent=q.label; b.onclick=()=>sendText(q.text); quickBar.appendChild(b); });
    }

    function renderStoreInfo(){
      const el=document.getElementById('storeInfo');
      el.innerHTML = `
        <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:</b> ${STORE.meta.name}</div>
        <div><b>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</b> ${STORE.meta.hours} (Open daily 10:00‚Äì20:00)</div>
        <div><b>‡πÇ‡∏ó‡∏£:</b> ${STORE.meta.phone}</div>
        <div><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${STORE.meta.address}</div>
        <div><b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${STORE.meta.lat.toFixed(4)}, ${STORE.meta.lng.toFixed(4)}</div>
        <div><b>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô:</b><br>${STORE.promos.map(p=>`‚Ä¢ ${p.title} ‚Äì ${p.desc}`).join('<br>')}</div>
      `;
      document.getElementById('mapsLink').href=STORE.meta.mapsUrl;
      document.getElementById('btnNavigate').onclick=()=>startNav();
    }

    function greet(){ bot('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üçú ‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "help" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á'); }
    function init(){ document.getElementById('lang').value='th'; renderQuick(); renderStoreInfo(); greet(); }
    init();
  </script>
</body>
</html>
